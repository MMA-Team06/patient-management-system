# ============================================
# Healthcare Clinic CI/CD Pipeline
# ============================================
# This pipeline runs on every push to develop/main
# and on every Pull Request to develop
#
# Jobs:
# 1. initiation - Startup message
# 2. tests-unitaires - Run all tests
# 3. qualite-du-code - SonarCloud analysis
# ============================================

name: Healthcare Clinic CI/CD Pipeline

# Trigger conditions
on:
  push:
    branches: 
      - develop
      - main
  pull_request:
    branches: 
      - develop

# Environment variables (available to all jobs)
env:
  NODE_VERSION: '18'
  MYSQL_VERSION: '8.0'

jobs:
  # ==========================================
  # JOB 1: INITIATION
  # ==========================================
  initiation:
    name: ğŸš€ Pipeline Initialization
    runs-on: ubuntu-latest
    
    steps:
      - name: Display pipeline info
        run: |
          echo "================================================"
          echo "ğŸ¥ Healthcare Clinic Management System"
          echo "================================================"
          echo "ğŸ“¦ Project: Patient Management System"
          echo "ğŸ‘¥ Team: UMBB Agile Development Team"
          echo "ğŸ”§ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "================================================"
          echo "âœ… Starting CI/CD Pipeline..."
          echo "================================================"

  # ==========================================
  # JOB 2: UNIT TESTS (Backend + Frontend)
  # ==========================================
  tests-unitaires:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: initiation
    
    # MySQL service container
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: patient_management_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CHECKOUT CODE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarCloud

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SETUP NODE.JS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # BACKEND TESTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          echo "Installing backend dependencies..."
          npm ci
          echo "âœ… Backend dependencies installed"

      - name: ğŸ—„ï¸ Setup Test Database
        run: |
          echo "Waiting for MySQL to be ready..."
          sleep 10
          mysql -h 127.0.0.1 -u root -ptest_password -e "CREATE DATABASE IF NOT EXISTS patient_management_test;"
          mysql -h 127.0.0.1 -u root -ptest_password patient_management_test < database/schema.sql
          echo "âœ… Test database created and schema loaded"

      - name: ğŸ§ª Run Backend Tests
        working-directory: ./backend
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: test_password
          DB_NAME: patient_management_test
          DB_PORT: 3306
          NODE_ENV: test
        run: |
          echo "Running backend unit tests..."
          npm test -- --coverage --verbose
          echo "âœ… Backend tests completed"

      - name: ğŸ“Š Display Backend Coverage Summary
        working-directory: ./backend
        run: |
          echo "================================================"
          echo "ğŸ“Š BACKEND TEST COVERAGE SUMMARY"
          echo "================================================"
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json
          else
            echo "âš ï¸ Coverage summary not found"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # FRONTEND TESTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          echo "âœ… Frontend dependencies installed"

      - name: ğŸ§ª Run Frontend Tests
        working-directory: ./frontend
        run: |
          echo "Running frontend unit tests..."
          npm test -- --coverage --verbose
          echo "âœ… Frontend tests completed"

      - name: ğŸ“Š Display Frontend Coverage Summary
        working-directory: ./frontend
        run: |
          echo "================================================"
          echo "ğŸ“Š FRONTEND TEST COVERAGE SUMMARY"
          echo "================================================"
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json
          else
            echo "âš ï¸ Coverage summary not found"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # UPLOAD COVERAGE REPORTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤ Upload Backend Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: ğŸ“¤ Upload Frontend Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SAVE COVERAGE ARTIFACTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ Save Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            backend/coverage/
            frontend/coverage/
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CHECK COVERAGE THRESHOLDS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Verify Coverage Thresholds
        run: |
          echo "================================================"
          echo "ğŸ¯ Checking Coverage Thresholds (Minimum: 70%)"
          echo "================================================"
          
          # Function to check coverage
          check_coverage() {
            local coverage_file=$1
            local module_name=$2
            
            if [ -f "$coverage_file" ]; then
              local coverage=$(grep -oP '"lines":\{"total":\d+,"covered":\d+,"skipped":\d+,"pct":\K[\d.]+' "$coverage_file" | head -1)
              echo "ğŸ“Š $module_name Coverage: ${coverage}%"
              
              if (( $(echo "$coverage < 70" | bc -l) )); then
                echo "âŒ FAILED: $module_name coverage below 70%"
                exit 1
              else
                echo "âœ… PASSED: $module_name coverage meets threshold"
              fi
            else
              echo "âš ï¸ WARNING: Coverage file not found for $module_name"
            fi
          }
          
          check_coverage "backend/coverage/coverage-summary.json" "Backend"
          check_coverage "frontend/coverage/coverage-summary.json" "Frontend"
          
          echo "================================================"
          echo "âœ… All coverage thresholds met!"
          echo "================================================"

  # ==========================================
  # JOB 3: CODE QUALITY (SonarCloud)
  # ==========================================
  qualite-du-code:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    needs: tests-unitaires
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CHECKOUT CODE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DOWNLOAD COVERAGE REPORTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SONARCLOUD SCAN
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Automatic
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Add this in GitHub Secrets
        with:
          args: >
            -Dsonar.projectKey=umbb-team_patient-management-system
            -Dsonar.organization=umbb-team
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
            -Dsonar.verbose=true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # QUALITY GATE CHECK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… SonarCloud Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DISPLAY RESULTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Display Quality Gate Results
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ” SONARCLOUD ANALYSIS COMPLETE"
          echo "================================================"
          echo "View detailed report at:"
          echo "https://sonarcloud.io/dashboard?id=umbb-team_patient-management-system"
          echo "================================================"

  # ==========================================
  # JOB 4: BUILD & DEPLOYMENT (Optional)
  # ==========================================
  build-and-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest
    needs: qualite-du-code
    if: github.ref == 'refs/heads/main'  # Only on main branch
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: |
          echo "Building production frontend..."
          npm run build
          echo "âœ… Frontend build completed"

      - name: ğŸ“¤ Deploy to Production
        run: |
          echo "================================================"
          echo "ğŸš€ DEPLOYMENT"
          echo "================================================"
          echo "âš ï¸ Deployment step placeholder"
          echo "In production, this would deploy to:"
          echo "  - AWS / Heroku / DigitalOcean"
          echo "  - Docker containers"
          echo "  - VPS server"
          echo "================================================"

  # ==========================================
  # FINAL STATUS
  # ==========================================
  pipeline-success:
    name: âœ… Pipeline Complete
    runs-on: ubuntu-latest
    needs: [tests-unitaires, qualite-du-code]
    if: success()
    
    steps:
      - name: ğŸ‰ Success Message
        run: |
          echo "================================================"
          echo "âœ… CI/CD PIPELINE COMPLETED SUCCESSFULLY"
          echo "================================================"
          echo "All checks passed:"
          echo "  âœ… Unit Tests"
          echo "  âœ… Code Coverage > 70%"
          echo "  âœ… SonarCloud Quality Gate"
          echo "================================================"
          echo "ğŸ‰ Ready for deployment!"
          echo "================================================"
```

---

## ğŸ“‹ PART 3: Setting Up GitHub Secrets

### **Required Secrets:**

1. **SONAR_TOKEN** (Already added in Step 4)
```
   Settings â†’ Secrets and variables â†’ Actions â†’ New secret
   Name: SONAR_TOKEN
   Value: sqp_xxxxxxxxxxxxxxxxxxxxx
```

2. **GITHUB_TOKEN** (Automatic - no action needed)
   - GitHub automatically provides this
   - Used for GitHub API access

### **Optional Secrets (for deployment):**

3. **DEPLOYMENT_KEY** (if deploying)
```
   Name: DEPLOYMENT_KEY
   Value: your-ssh-key-or-api-token